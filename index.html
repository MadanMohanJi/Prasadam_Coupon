<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§Æ‡•ã‡§°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@100..900&display=swap');
        body { font-family: 'Noto Sans Devanagari', sans-serif; background-color: #fff1f2; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-lg bg-white shadow-xl rounded-xl p-8 text-center border-2 border-red-200">
        <h1 class="text-2xl font-bold text-red-600 mb-2">üöë ‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§ü‡•Ç‡§≤</h1>
        <p class="text-gray-600 mb-6">‡§Ø‡§π ‡§ü‡•Ç‡§≤ 'Private Folders' ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡§ï‡•á ‡§µ‡§æ‡§™‡§∏ ‡§≤‡§æ‡§è‡§ó‡§æ‡•§</p>

        <div id="status-box" class="bg-gray-100 p-4 rounded mb-4 text-left text-sm h-40 overflow-y-auto font-mono">
            ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à...<br>
        </div>

        <button onclick="startRecovery()" id="recover-btn" class="w-full bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700 shadow-lg">
            üîç ‡§°‡•á‡§ü‡§æ ‡§¢‡•Ç‡§Å‡§¢‡•á‡§Ç ‡§î‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (Start Recovery)
        </button>
        
        <p id="index-error-msg" class="text-red-600 text-xs mt-4 hidden">
            <b>‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç:</b> ‡§Ö‡§ó‡§∞ ‡§Ø‡§π ‡§ï‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ, ‡§§‡•ã Console (F12) ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§ Firebase ‡§Ü‡§™‡§ï‡•ã ‡§è‡§ï ‡§≤‡§ø‡§Ç‡§ï ‡§¶‡•á‡§ó‡§æ, ‡§â‡§∏ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§ï‡•á Index ‡§¨‡§®‡§æ‡§è‡§Ç‡•§
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collectionGroup, getDocs, doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDlyRBUS_Dg2qXuSVHWjRlnE2ZjTxPEXbo",
            authDomain: "prasadam-coupon-d1351.firebaseapp.com",
            projectId: "prasadam-coupon-d1351",
            storageBucket: "prasadam-coupon-d1351.firebasestorage.app",
            messagingSenderId: "475680540304",
            appId: "1:475680540304:web:d9b4836d7ea1a709f2fa15",
            measurementId: "G-2VLPJ634P3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;
        const statusBox = document.getElementById('status-box');

        function log(msg) {
            statusBox.innerHTML += `> ${msg}<br>`;
            statusBox.scrollTop = statusBox.scrollHeight;
        }

        window.startRecovery = async function() {
            const btn = document.getElementById('recover-btn');
            btn.disabled = true;
            btn.textContent = "‡§∏‡•ç‡§ï‡•à‡§®‡§ø‡§Ç‡§ó ‡§ö‡§≤ ‡§∞‡§π‡•Ä ‡§π‡•à...";
            log("‡§∏‡•ç‡§ï‡•à‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...");

            let recoveredData = [];

            try {
                // ‡§Ø‡§π 'registrations' ‡§®‡§æ‡§Æ ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§∏‡§¨-‡§´‡•ã‡§≤‡•ç‡§°‡§∞‡•ç‡§∏ ‡§ï‡•ã ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§ó‡§æ
                const q = collectionGroup(db, 'registrations');
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    log("‚ùå ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
                    btn.disabled = false;
                    return;
                }

                log(`‚úÖ ${querySnapshot.size} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§Æ‡§ø‡§≤‡•á!`);
                log("‡§°‡•á‡§ü‡§æ ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...");

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ‡§Ö‡§ó‡§∞ ‡§°‡•á‡§ü‡§æ ‡§Æ‡•á‡§Ç ‡§®‡§æ‡§Æ ‡§π‡•à, ‡§§‡•ã ‡§â‡§∏‡•á ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                    if (data.name) {
                        recoveredData.push(data);
                    }
                });

                log("CSV ‡§´‡§æ‡§á‡§≤ ‡§¨‡§®‡§æ‡§à ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...");
                exportRecoveredData(recoveredData);
                
                // Optional: Restore to main list (Uncomment if needed)
                // await restoreToMainList(recoveredData);

            } catch (error) {
                console.error(error);
                log("‚ùå ERROR: " + error.message);
                
                if (error.message.includes("requires an index")) {
                    log("‚ö†Ô∏è INDEX REQUIRED: ‡§ï‡§Ç‡§∏‡•ã‡§≤ (F12) ‡§ñ‡•ã‡§≤‡•á‡§Ç ‡§î‡§∞ Firebase ‡§≤‡§ø‡§Ç‡§ï ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§");
                    document.getElementById('index-error-msg').classList.remove('hidden');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = "‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç";
            }
        };

        function exportRecoveredData(data) {
            if (data.length === 0) { log("‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§"); return; }

            const headers = ["Name", "Contact", "Linked Devotee", "Timestamp", "User ID"];
            const rows = data.map(row => {
                const safe = (text) => `"${(text || "").toString().replace(/"/g, '""')}"`;
                return [
                    safe(row.name),
                    safe(row.contact),
                    safe(row.address),
                    safe(row.timestamp),
                    safe(row.userId)
                ].join(",");
            });

            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `RECOVERED_DATA_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            log("üéâ ‡§∏‡§´‡§≤‡§§‡§æ! ‡§´‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à ‡§π‡•à‡•§");
        }
    </script>
</body>
</html>
