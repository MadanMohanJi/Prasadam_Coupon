<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Recovery Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 text-center bg-gray-50">

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg border border-indigo-200">
        <h1 class="text-2xl font-bold text-indigo-700 mb-2">Deep Data Recovery</h1>
        <p class="text-gray-600 mb-6">‡§Ø‡§π ‡§ü‡•Ç‡§≤ ‡§õ‡•Å‡§™‡•á ‡§π‡•Å‡§è 'Private User Folders' ‡§ï‡•ã ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§ó‡§æ‡•§</p>

        <button onclick="startDeepScan()" id="scan-btn" class="bg-indigo-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-lg transition">
            üöÄ ‡§∏‡•ç‡§ï‡•à‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç (Start Scan)
        </button>

        <div id="logs" class="mt-6 text-left bg-black text-green-400 p-4 h-64 overflow-auto font-mono text-xs rounded border border-gray-400">
            Waiting for user action...<br>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collectionGroup, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ‡§Ü‡§™‡§ï‡•Ä CONFIG (Prasadam Coupon) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlyRBUS_Dg2qXuSVHWjRlnE2ZjTxPEXbo",
            authDomain: "prasadam-coupon-d1351.firebaseapp.com",
            projectId: "prasadam-coupon-d1351",
            storageBucket: "prasadam-coupon-d1351.firebasestorage.app",
            messagingSenderId: "475680540304",
            appId: "1:475680540304:web:d9b4836d7ea1a709f2fa15",
            measurementId: "G-2VLPJ634P3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const logs = document.getElementById('logs');
        const btn = document.getElementById('scan-btn');

        function log(msg) { 
            logs.innerHTML += `> ${msg}<br>`; 
            logs.scrollTop = logs.scrollHeight;
        }

        window.startDeepScan = async function() {
            btn.disabled = true;
            btn.textContent = "Scanning...";
            log("Connecting to Database...");
            log(`Project ID: ${firebaseConfig.projectId}`);

            try {
                // ‡§Ø‡§π 'registrations' ‡§®‡§æ‡§Æ ‡§ï‡•á ‡§π‡§∞ ‡§´‡•ã‡§≤‡•ç‡§°‡§∞ ‡§ï‡•ã ‡§¢‡•Ç‡§Ç‡§¢‡•á‡§ó‡§æ
                const q = collectionGroup(db, 'registrations');
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    log("‚ùå SCAN COMPLETE: ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
                    log("‡§ï‡§æ‡§∞‡§£: ‡§Ø‡§æ ‡§§‡•ã ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§ñ‡§æ‡§≤‡•Ä ‡§π‡•à, ‡§Ø‡§æ 'Index' ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§®‡§æ ‡§π‡•à‡•§");
                    log("‡§Ö‡§ó‡§∞ ‡§Ü‡§™‡§®‡•á Console ‡§∏‡•á ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤‡•Ä ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§•‡§æ, ‡§§‡•ã ‡§°‡•á‡§ü‡§æ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ó‡§Ø‡§æ‡•§");
                } else {
                    log(`‚úÖ SUCCESS: ${snapshot.size} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏ ‡§Æ‡§ø‡§≤‡•á!`);
                    log("CSV ‡§´‡§æ‡§á‡§≤ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...");
                    
                    let csvContent = "data:text/csv;charset=utf-8,Name,Contact,Devotee,Date,UserID\n";
                    
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        // ‡§ï‡§≠‡•Ä-‡§ï‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ 'entryCard' ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§π‡•ã‡§§‡§æ ‡§π‡•à
                        const name = d.name || "N/A";
                        const contact = d.contact || "N/A";
                        const devotee = d.address || "N/A";
                        const date = d.timestamp || "N/A";
                        const uid = d.userId || "N/A";

                        const row = `"${name}","${contact}","${devotee}","${date}","${uid}"`;
                        csvContent += row + "\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "Restored_Data_Final.csv");
                    document.body.appendChild(link);
                    link.click();
                    
                    log("üéâ ‡§´‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à ‡§π‡•à!");
                }

            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`);
                
                if (error.message.includes("requires an index")) {
                    log("‚ö†Ô∏è ACTION REQUIRED: ‡§®‡•Ä‡§ö‡•á ‡§è‡§ï ‡§≤‡§ø‡§Ç‡§ï ‡§π‡•à, ‡§â‡§∏ ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç!");
                    // ‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•ã ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§¨‡§®‡§æ‡§®‡§æ
                    const linkMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                    if (linkMatch) {
                        log(`<a href="${linkMatch[0]}" target="_blank" style="color: yellow; text-decoration: underline;">üëâ CLICK HERE TO CREATE INDEX üëà</a>`);
                    } else {
                        log("‡§ï‡§Ç‡§∏‡•ã‡§≤ (F12) ‡§ñ‡•ã‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§≤‡§ø‡§Ç‡§ï ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
                    }
                }
            } finally {
                btn.disabled = false;
                btn.textContent = "Scan Again";
            }
        };
    </script>
</body>
</html>
