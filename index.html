<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5 Dec Data Recovery</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 text-center bg-blue-50">

    <div class="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg border border-blue-200">
        <h1 class="text-2xl font-bold text-blue-800 mb-2">üìÖ 5 December Recovery Tool</h1>
        <p class="text-gray-600 mb-6">‡§Ø‡§π ‡§ü‡•Ç‡§≤ ‡§ï‡•á‡§µ‡§≤ <b>5 ‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞</b> ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§õ‡§æ‡§Ç‡§ü‡§ï‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§ó‡§æ‡•§</p>

        <button onclick="recoverSpecificDate()" id="scan-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition">
            üì• 5 ‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        </button>

        <div id="logs" class="mt-6 text-left bg-black text-yellow-400 p-4 h-64 overflow-auto font-mono text-xs rounded border border-gray-400">
            System Ready... Waiting for command.<br>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collectionGroup, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- ‡§Ü‡§™‡§ï‡•Ä CONFIG (Prasadam Coupon) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlyRBUS_Dg2qXuSVHWjRlnE2ZjTxPEXbo",
            authDomain: "prasadam-coupon-d1351.firebaseapp.com",
            projectId: "prasadam-coupon-d1351",
            storageBucket: "prasadam-coupon-d1351.firebasestorage.app",
            messagingSenderId: "475680540304",
            appId: "1:475680540304:web:d9b4836d7ea1a709f2fa15",
            measurementId: "G-2VLPJ634P3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const logs = document.getElementById('logs');
        const btn = document.getElementById('scan-btn');

        function log(msg) { 
            logs.innerHTML += `> ${msg}<br>`; 
            logs.scrollTop = logs.scrollHeight;
        }

        window.recoverSpecificDate = async function() {
            btn.disabled = true;
            btn.textContent = "Scanning & Filtering...";
            log("Connecting to Database...");
            
            // TARGET DATE: 5 December
            const targetDay = 5;
            const targetMonth = 11; // JavaScript ‡§Æ‡•á‡§Ç December = 11 (0-11)

            try {
                // 1. ‡§∏‡§æ‡§∞‡§æ ‡§°‡•á‡§ü‡§æ ‡§Æ‡§Ç‡§ó‡§æ‡§è‡§Ç (Client-side filtering is safer for indexes)
                const q = collectionGroup(db, 'registrations');
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    log("‚ùå DATABASE EMPTY: ‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§");
                    return;
                }

                log(`üîç Total Records Scanned: ${snapshot.size}`);
                log("Filtering for 5th December...");

                let csvContent = "data:text/csv;charset=utf-8,Name,Contact,Devotee,Date,UserID\n";
                let count = 0;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if (d.timestamp) {
                        const entryDate = new Date(d.timestamp);
                        
                        // Check if Date is 5 AND Month is December
                        if (entryDate.getDate() === targetDay && entryDate.getMonth() === targetMonth) {
                            
                            const name = d.name || "N/A";
                            const contact = d.contact || "N/A";
                            const devotee = d.address || "N/A"; // Using address field for devotee
                            const dateStr = entryDate.toLocaleString();
                            const uid = d.userId || "N/A";

                            // CSV Row
                            const row = `"${name}","${contact}","${devotee}","${dateStr}","${uid}"`;
                            csvContent += row + "\n";
                            count++;
                        }
                    }
                });

                if (count === 0) {
                    log("‚ö†Ô∏è 5 ‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞ ‡§ï‡•Ä ‡§ï‡•ã‡§à ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§");
                } else {
                    log(`‚úÖ SUCCESS: 5 ‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞ ‡§ï‡•á ${count} ‡§≤‡•ã‡§ó ‡§Æ‡§ø‡§≤‡•á!`);
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "Data_5_Dec_Only.csv");
                    document.body.appendChild(link);
                    link.click();
                    
                    log("üéâ ‡§´‡§æ‡§á‡§≤ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à ‡§π‡•à!");
                }

            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`);
                if (error.message.includes("requires an index")) {
                    const linkMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/);
                    if (linkMatch) {
                        log(`<a href="${linkMatch[0]}" target="_blank" style="color: yellow; text-decoration: underline;">üëâ CLICK HERE TO CREATE INDEX üëà</a>`);
                    }
                }
            } finally {
                btn.disabled = false;
                btn.textContent = "Scan Again";
            }
        };
    </script>
</body>
</html>
